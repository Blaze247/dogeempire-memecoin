#!/bin/bash
# =========================================================
# OAuth Login Flow Verifier (DEFENSIVE / SOC)
# Purpose: Validate real-time login domains against known-good YAML
# =========================================================

INTERFACE="eth0"
CAPTURE_TIME=30
WORKDIR="/tmp/oauth_check"
EXPECTED="$WORKDIR/expected_domains.txt"
OBSERVED_RAW="$WORKDIR/observed_raw.txt"
OBSERVED="$WORKDIR/observed_domains.txt"

mkdir -p "$WORKDIR"

# -----------------------------
# Expected allow-list
# -----------------------------
cat << 'EOF' > "$EXPECTED"
accounts.google.com
oauth2.googleapis.com
apis.google.com
ssl.gstatic.com
fonts.gstatic.com
clients6.google.com
www.facebook.com
facebook.com
connect.facebook.net
graph.facebook.com
fbcdn.net
EOF

echo "[*] Starting TLS SNI capture for $CAPTURE_TIME seconds..."
echo "[*] Open Google or Facebook login in your browser NOW."

timeout "$CAPTURE_TIME" tshark -i "$INTERFACE" \
-Y "tls.handshake.extensions_server_name" \
-T fields \
-e tls.handshake.extensions_server_name \
2>/dev/null > "$OBSERVED_RAW"

# -----------------------------
# Normalize observed domains
# -----------------------------
sed \
-e 's/^.*\.fbcdn\.net$/fbcdn.net/' \
-e 's/^.*\.googleusercontent\.com$/googleusercontent.com/' \
"$OBSERVED_RAW" | sort -u > "$OBSERVED"

# -----------------------------
# Compare
# -----------------------------
UNEXPECTED=$(comm -23 "$OBSERVED" "$EXPECTED")
LANDING=$(head -n 1 "$OBSERVED_RAW")

SEVERITY="LOW"
REASON="Flow matches expected domains"

if [ -n "$UNEXPECTED" ]; then
  SEVERITY="HIGH"
  REASON="Unexpected domain(s) observed"
fi

if [[ "$LANDING" != "accounts.google.com" && "$LANDING" != "www.facebook.com" ]]; then
  SEVERITY="CRITICAL"
  REASON="Landing page domain mismatch"
fi

# -----------------------------
# Output report
# -----------------------------
echo
echo "================ FLOW REPORT ================"
echo "Landing domain detected : $LANDING"
echo
echo "Observed domains:"
cat "$OBSERVED"
echo
echo "Unexpected domains:"
if [ -n "$UNEXPECTED" ]; then
  echo "$UNEXPECTED"
else
  echo "None"
fi
echo
echo "Severity : $SEVERITY"
echo "Reason   : $REASON"
echo "============================================="

